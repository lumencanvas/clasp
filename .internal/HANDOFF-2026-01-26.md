# Session Handoff - January 26, 2026

## Summary

This session implemented the CLASP v3.2.0 release plan (fixing limitations), published all packages, conducted a comprehensive production readiness audit, and fixed critical security issues.

---

## Completed Work

### 1. V3.2.0 Features Implemented

| Feature | Files Changed | Description |
|---------|---------------|-------------|
| **TTL Configuration** | `router.rs`, `relay/main.rs` | Configurable param/signal TTL via CLI (`--param-ttl`, `--signal-ttl`, `--no-ttl`) |
| **Drop Notifications** | `session.rs`, `router.rs` | ERROR 503 sent to slow clients when buffer overflow detected (100 drops in 10s) |
| **Rendezvous Integration** | `discovery/lib.rs` | WAN discovery via rendezvous server with auto-keepalive |
| **Cascade Discovery** | `discovery/lib.rs` | `discover_all()` tries mDNS → broadcast → rendezvous |

### 2. Packages Published

| Package | Version | Registry |
|---------|---------|----------|
| clasp-core | 3.2.0 | crates.io |
| clasp-router | 3.2.0 | crates.io |
| clasp-transport | 3.2.0 | crates.io |
| clasp-discovery | 3.2.0 | crates.io |
| clasp-adapters | 3.2.0 | crates.io |
| clasp-service | 3.2.0 | crates.io |
| clasp-cli | 3.2.0 | crates.io |
| @clasp-to/core | 3.2.0 | npm |
| clasp-to | 3.2.0 | PyPI |

### 3. Security Fixes Applied

| Issue | Fix | File |
|-------|-----|------|
| **QUIC insecure default** | Changed default from `SkipVerification` to `SystemRoots` | `quic.rs:40-43` |
| **Token file permissions** | Added chmod 0600 on Unix | `tokens.rs:149` |
| **MQTT token validation** | Implemented full validation using `TokenValidator` | `mqtt_server.rs:367-430` |
| **Silent error drops** | Added error logging for TCP failures | `server.rs:119` |

### 4. Production Readiness Audit Completed

See full audit details below in "Audit Findings" section.

---

## Commits Made

```
0c4f4ee chore(site): update @clasp-to/core to 3.2.0
e7f223f fix(security): address critical security issues from audit
126191f chore(relay): update to use published clasp crates 3.2
[v3.2.0 release commit - all features]
```

---

## Audit Findings

### Production Ready Now

- Core protocol, router, WebSocket, TCP, QUIC transports
- MQTT bridge (with auth now implemented)
- OSC bridge
- Token authentication (CPSK)
- mDNS + rendezvous discovery
- Docker deployment with health checks

### Remaining Issues (Prioritized)

#### HIGH (Should Fix Before Heavy Production)

| Issue | Effort | Notes |
|-------|--------|-------|
| No Prometheus metrics | Medium | Add `/metrics` endpoint |
| No HTTP health endpoint for router | Low | Add `/health` to relay |
| No SIGTERM/SIGINT handlers | Low | Add graceful shutdown |
| No exponential backoff for reconnects | Low | Fixed 5s delay currently |
| saCN/SocketIO/DMX bridges untested | Medium | 581+345+371 LOC with 0 tests |
| artnet_protocol version conflict | Low | 0.2.0 vs 0.4.4 in workspace |

#### MEDIUM

- Multiple `rcgen` versions (0.11, 0.12, 0.13)
- Unmaintained protocol deps (rosc, midir pre-v1.0)
- HTTP bridge only has 2 tests
- 20+ message types lack doc comments
- No config file support (only CLI/env)
- No per-IP connection limits

#### LOW

- Some unused code warnings
- Missing CHANGELOG.md
- No k8s deployment manifests

---

## Files Modified This Session

### Core Changes
- `crates/clasp-router/src/router.rs` - State config, drop tracking
- `crates/clasp-router/src/session.rs` - Drop counter, notification logic
- `crates/clasp-router/src/adapters/mqtt_server.rs` - Token validation
- `crates/clasp-discovery/src/lib.rs` - Rendezvous integration
- `crates/clasp-transport/src/quic.rs` - Secure default
- `crates/clasp-cli/src/tokens.rs` - File permissions
- `crates/clasp-cli/src/server.rs` - Error logging

### Configuration/Deployment
- `deploy/relay/src/main.rs` - TTL CLI flags
- `deploy/relay/Cargo.toml` - Updated to published 3.2

### Tests
- `crates/clasp-transport/tests/quic_tests.rs` - Use SkipVerification explicitly

### Documentation
- `docs/api/common/discovery.md` - Rendezvous section
- `docs/reference/protocol/messages.md` - ERROR 503
- `crates/clasp-router/README.md` - TTL config
- `crates/clasp-discovery/README.md` - Rendezvous
- `deploy/relay/README.md` - CLI flags
- `.internal/CAPABILITIES-REALITY.md` - Updated status

### Version Bumps
- Root `Cargo.toml` (workspace) → 3.2.0
- `bindings/js/packages/clasp-core/package.json` → 3.2.0
- `bindings/python/pyproject.toml` → 3.2.0
- `apps/bridge/package.json` → 0.4.0
- `site/package.json` → @clasp-to/core 3.2.0

---

## GitHub Release

**v3.2.0**: https://github.com/lumencanvas/clasp/releases/tag/v3.2.0

Release notes include:
- TTL configuration
- Drop notifications
- Rendezvous integration
- Published package links

---

## Next Steps (Suggested)

### Immediate
1. Monitor v3.2.0 in production for issues
2. Consider adding Prometheus metrics (`/metrics` endpoint)
3. Add signal handlers for graceful shutdown

### Short-term
1. Write tests for saCN, SocketIO, DMX bridges
2. Resolve artnet_protocol version conflict
3. Add HTTP health check endpoint to relay

### Long-term
1. Create k8s deployment manifests
2. Add CHANGELOG.md for release notes
3. Evaluate unmaintained deps (rosc, midir)

---

## Test Status

All 497 workspace tests pass. No regressions introduced.

---

## Environment Notes

- macOS Darwin 21.6.0
- Rust workspace with 3.2.0 version
- npm packages updated in site/
- All packages published to registries
