# Handoff - 2026-02-19

## Session Summary

Six sessions completed. Sessions 1-4: tests, relay persistence, deployment, room sharing/admin overhaul, auth scope fixes. Session 5: video/crypto/audit fix sweep. Session 6: namespace-based room organization with full security audit.

### Session 1: Comprehensive Tests + Relay Persistence

Implemented the full plan from `streamed-humming-sunbeam.md`:

**Frontend tests (59 new, 112 total across 8 files):**
- `useCrypto.test.js` — 19 tests: ECDH key exchange, password proof gating, key rotation, encrypt/decrypt roundtrip, full two-peer integration test
- `useChat.test.js` — 16 tests: send/edit/delete messages, encrypted payloads, rate limiting, incoming message handling via subscribe callbacks
- `useFriends.test.js` — 16 tests: two-step friend handshake, request dedup, accept/decline/remove
- `storage.test.js` — 8 tests: IndexedDB CRUD with fake-indexeddb, export sanitization

**Relay persistence:**
- `--persist <PATH>` and `--persist-interval <SECS>` CLI flags on relay binary
- Restore state from JSON snapshot on startup
- Background task snapshots every N seconds (atomic write via .tmp + rename)
- Graceful shutdown writes final snapshot (SIGINT/SIGTERM)
- 4 Rust integration tests for snapshot/restore

### Session 2: Deployment Pipeline

**GitHub secrets configured:**
- `DROPLET_IP` = 157.230.84.254
- `DROPLET_SSH_KEY` = ~/.ssh/id_ed25519

**Deploy workflow (.github/workflows/deploy-relay.yml):**
- Push to `deploy/relay/**` or `crates/**` triggers Docker build → GHCR push → Droplet pull/restart
- GHCR auth via GITHUB_TOKEN passed to Droplet SSH session

### Session 3: Room Sharing, Discovery Fix, Admin UI Overhaul

Implemented the full plan from `streamed-humming-sunbeam.md` (Phases 1-3):

**Phase 1 — UUID IDs + Registry Fix:**
- Room IDs changed from `generateId(8)` to `crypto.randomUUID()`
- Private rooms no longer written to public registry
- DMs no longer written to registry
- `fetchRoomMeta(roomId)` extracted for invite link flow
- Browse Public Channels fix: iterate `client.params` cache for pre-existing SNAPSHOT state (CLASP notifies subscribers on SNAPSHOT, but timing means subscriptions may register after SNAPSHOT processing)
- `updateRoomData(roomId, updates)` added to safely mutate the `readonly(rooms)` ref

**Phase 2 — Invite Links (`?join=roomId`):**
- Router guard forwards `?join` param when redirecting to `/auth`
- JoinPage forwards `?join` to `/chat` after connecting
- AuthPage forwards `?join` through login/register flow
- ChatPage `handleInviteJoin(roomId)`: checks existing membership, fetches room meta, handles password-protected rooms with prompt dialog
- Invite password dialog overlay in ChatPage template

**Phase 3 — Admin Panel Overhaul:**
- AdminPanel restructured: Invite Link section (all members), Room Settings (admins), Member Management, Ban List, Danger Zone
- useAdmin: `roomMeta` ref, `subscribeRoomMeta()`, `updateRoomName()`, `togglePublic()`, `updatePassword()`, `unbanUser()`, `bannedUsers` changed from Set to Map with full ban details
- Mod-delete wired through MessageList → ChatView
- Room meta changes sync back to rooms Map via useChat subscription
- RoomCreateDialog password field behind toggle

**Bugs caught in audit:**
- `readonly(rooms)` mutation: useAdmin/useChat/ChatPage tried `rooms.value.set()` on a readonly ref — fixed with `updateRoomData()` in useRooms
- AdminPanel `editName` blank on open: `onMounted` read `roomMeta` before async subscription fires — fixed with `watch(roomMeta, ..., { immediate: true })`
- SPA 404 on refresh: added `public/_redirects` for Netlify/compatible hosts

**Commit:** `6be7674` feat(chat): room sharing, discovery fix, admin UI overhaul, SPA routing

### Session 4: Auth Scope Fix + Join Link Fix

**Root cause of CLASP 301 errors:**
The auth endpoint (`/auth/guest`, `/auth/register`) generated its own `user_id` (format `u-{timestamp}-{random}`) and built CPSK token scopes around it (e.g. `write:/chat/room/*/presence/u-123-abc`). But the frontend's `useIdentity` used a separate `crypto.randomUUID()` as its userId. All writes to presence, typing, and profile paths used the frontend's UUID, which didn't match the token scopes — resulting in 301 "Insufficient scope" errors.

**Fix (relay + frontend):**

| File | Change |
|------|--------|
| `deploy/relay/src/auth.rs` | Guest and register endpoints accept optional `user_id` field; if provided, scopes are built around the client's userId |
| `apps/chat/src/composables/useIdentity.js` | Added `setUserId()` to update identity from server response |
| `apps/chat/src/composables/useAuth.js` | `register()` accepts optional `existingUserId`, sends as `user_id` in request body |
| `apps/chat/src/pages/JoinPage.vue` | Sends `user_id: userId.value` in guest token request; preserves `?join` in auth link |
| `apps/chat/src/pages/AuthPage.vue` | After login/register, adopts server's stable userId via `setUserId(authUserId.value)` |
| `apps/chat/src/pages/ChatPage.vue` | Connected watch preserves `?join` param across redirect to `/` |

**Behavior after fix:**
- **Guests**: Frontend sends its own UUID → server builds scopes around it → scopes match → no 301 errors
- **Register**: Frontend sends current userId → server stores it as account ID → identity continuity from guest to registered
- **Login**: Server returns stored userId → frontend adopts it → consistent identity across devices

**Join link fix:**
The `watch(connected, ..., { immediate: true })` in ChatPage fired before `onMounted`, saw `connected=false`, and redirected to `/` — losing the `?join=` param. Fixed by preserving the join param in the redirect URL. Also fixed JoinPage's "Sign up or sign in" link to forward the join param.

**Commit:** `316e60e` fix(auth): align token scopes with frontend userId, fix join link flow

### Session 5: Video Fix, Pre-Join Lobby, Crypto Key Exchange, Audit Fixes

Three commits pushed to main:

**Commit 1:** `7ab1181` — Full sweep

| Area | Fix |
|------|-----|
| **Relay auth** | Added `write:/chat/room/*/video/**` scope — video presence and signaling writes were getting 301 errors in all rooms |
| **WebRTC transceivers** | Moved `recvonly` transceiver creation into `if (initiator)` block — non-initiators were getting duplicate media sections from both manual add + `setRemoteDescription` |
| **WebRTC ontrack** | Fallback to `existing.stream \|\| new MediaStream()` when `event.streams[0]` is undefined |
| **ICE cleanup** | Added `iceCandidateQueues.delete(peerId)` in `failed` and `disconnected` cleanup paths |
| **Pre-join lobby** | Replaced 3-button layout (Camera/Audio/Spectate) with conferencing lobby: independent mic/cam toggles + single "Join Call" button |
| **Spectator→enable** | Added `getUserMediaSelective()`, `enableAudio()`, `enableVideo()` to useVideoRoom — spectators can turn on mic/camera after joining, renegotiates with peers |
| **Renegotiation** | `handleSignal` reuses existing connection for offers to already-connected peers (needed for enableAudio/enableVideo mid-call) |
| **Crypto key exchange** | New joiners now call `requestRoomKey()` which publishes their ECDH public key — existing members respond with the room key. Previously new joiners never published their key, so nobody knew to send them the room key (stuck in `waitingForKey` forever) |
| **Key retry** | 5-second interval re-publishes public key while `waitingForKey` is true, cleared when key arrives or room is left |
| **Key rotation** | `rotateRoomKey()` now proactively distributes the new key to all cached peer public keys (via `peerPublicKeys` Map). Previously it only republished own public key, which made existing members respond with the OLD key |
| **Re-keying** | Removed `roomKeys.has(roomId)` guard from `keyex` handler — accepts new keys even if one exists (required for rotation) |
| **Subscription leak** | ChatView: `subscribeBans()`/`subscribeAdmins()` return values now stored and cleaned up in `onUnmounted` |
| **Race condition** | useChat: `joinAbortId` counter with bail-after-await checks prevents stale subscriptions on rapid room switching |
| **Friends cleanup** | `useFriends.cleanup()` now resets `friends` and `pendingRequests` state; called in `handleLogout` before `disconnect()` |
| **Error on reconnect** | `useClasp` `onReconnect` callback now clears `error.value` |
| **XSS hardening** | Added single-quote to markdown `escapeHtml` map |

**Commit 2:** `73377ac` — Follow-up fixes

- Moved `subscribeKeyExchange()` BEFORE `requestRoomKey()` so the `keyex/{userId}` response handler is active when existing members respond (previously first request was wasted, only 5s retry worked)
- Added `removePeerKey(roomId, peerId)` — called before `rotateRoomKey()` in ban flow to prevent sending the new key to the banned user
- Fixed desktop combo view: collapsed video had `display: none` which hid the toggle button too — changed to `flex: 0 0 auto` so the "Show Video" bar stays visible

**Commit 3:** `f1526e3` — Lobby UX polish

- Lobby defaults mic/cam to OFF (both toggle buttons start red/off)
- No auto permission prompt on mount — user toggles camera on to grant, sees preview, then joins
- Fixed video preview not rendering: `attachStream` now uses `await nextTick()` before setting `srcObject`, so the `v-if` video element is in the DOM

### Session 6: Namespace-Based Room Organization + Security Audit

Implemented the full plan from `sunny-popping-moth.md` across 5 phases, then performed a security audit and fixed all findings.

**Why:** As the number of rooms grows, the flat sidebar list and flat discovery grid become unwieldy. CLASP's hierarchical path-based addressing is a natural fit for namespace-based categorization. Namespaces organize rooms into expandable tree structures in both the sidebar and discovery UI, with real-time updates via CLASP wildcard subscriptions.

**CLASP Path Design:**
```
/chat/registry/ns/{namespace}/{roomId}        — room membership in a namespace
/chat/registry/ns-meta/{namespace}            — namespace metadata (public info)
/chat/registry/ns-meta/{namespace}/__auth     — password hash/salt (separate from browsable meta)
```

Namespaces are decoupled from room data — room paths (`/chat/room/{roomId}/...`) are unchanged. A room can exist in a namespace OR be unnamespaced (backward compatible). Moving rooms between namespaces is a registry delete + set (no data migration).

**Phase 1 — Foundation:**

| File | Change |
|------|--------|
| `apps/chat/src/lib/constants.js` | Added `NS_REGISTRY`, `NS_META` address constants to ADDR |
| `deploy/relay/src/auth.rs` | Added 2 scopes: `write:/chat/registry/ns/**`, `write:/chat/registry/ns-meta/**` |
| `apps/chat/src/composables/useNamespaces.js` | **NEW** — Full composable: namespace CRUD, CLASP wildcard subscriptions, reactive tree building, pin/unpin, password unlock, discovery, path sanitization |

Key composable functions:
- `subscribeNamespace(ns)` / `subscribeNamespaceDeep(ns)` — shallow (`*`) vs recursive (`**`) wildcard subs
- `discoverTopLevelNamespaces()` / `discoverChildNamespaces(ns)` — browse `ns-meta/*` for public namespaces
- `createNamespace(path, opts)` — async, hashes password with PBKDF2, stores hash at `__auth` sub-path
- `registerRoomInNamespace()` / `removeRoomFromNamespace()` — registry writes
- `pinNamespace()` / `unpinNamespace()` — sidebar management, persisted to localStorage
- `unlockNamespace(ns, password)` — fetches `__auth`, verifies PBKDF2 hash, auto-pins on success
- `lookupNamespace(ns)` — returns meta + `hasPassword` flag (never exposes hash)
- `sanitizeNsPath(path)` — rejects `..`, `*`, `**`, empty segments, non-alphanumeric chars

**Phase 2 — Sidebar:**

| File | Change |
|------|--------|
| `apps/chat/src/components/NamespaceGroup.vue` | **NEW** — Recursive collapsible component: chevron toggle, room list with type icons, join hints for unjoined rooms, unread badges, child namespace recursion |
| `apps/chat/src/components/AppSidebar.vue` | Added pinned namespace section between room list and DMs; filters namespaced rooms from flat list via `namespacedRoomIds` computed |

Sidebar structure is now: Rooms (ungrouped) → Pinned Namespaces (each as NamespaceGroup tree) → DMs.

**Phase 3 — Discovery:**

| File | Change |
|------|--------|
| `apps/chat/src/components/RoomDiscovery.vue` | Full redesign: namespace grid at top, private namespace unlock input, uncategorized rooms at bottom. Drill-in view: sub-namespaces grid + rooms grid + pin/settings buttons. Namespace settings overlay for creators. |
| `apps/chat/src/components/NamespaceCard.vue` | **NEW** — Card component for namespace grid: name, description, room count, pin/unpin button |

Three namespace visibility tiers:
- **Public** (`isPublic: true`) — appears in discovery browse, anyone can pin
- **Private unlisted** (`isPublic: false`, no password) — hidden from browse, accessible by typing exact path
- **Private password-protected** (`isPublic: false`, has password) — hidden, requires password to unlock. Session-scoped: must re-enter each session

**Phase 4 — Room Creation:**

| File | Change |
|------|--------|
| `apps/chat/src/components/RoomCreateDialog.vue` | Added namespace combo-box with autocomplete (pinned + unlocked namespaces), new namespace toggle (private + password options) |
| `apps/chat/src/composables/useRooms.js` | `createRoom()` accepts optional `namespace` param, writes to both `NS_REGISTRY` and public registry |
| `apps/chat/src/pages/ChatPage.vue` | Integrated `useNamespaces`, `handleCreateRoom` awaits namespace creation before room registration |

**Phase 5 — Admin + Polish:**

| File | Change |
|------|--------|
| `apps/chat/src/components/AdminPanel.vue` | Added namespace management section: view current namespace, change/remove via combo-box dropdown. Auth-gated: admin-only, target namespace must be pinned/unlocked |
| Namespace settings | Creator-only gear icon in discovery drill-in: edit description, icon, toggle public/private |
| Storage persistence | `subscribedNamespaces` persisted to `localStorage` via `persistPinned()`. `initPinnedNamespaces()` rehydrates and re-subscribes on mount. `unlockedNamespaces` is session-only (security: prevents stale access if password changes) |

**Security Audit — Issues Found & Fixed:**

| Severity | Issue | Fix |
|----------|-------|-----|
| **CRITICAL** | Path injection — namespace paths like `../../room/x/meta` could traverse CLASP address hierarchy | Added `sanitizeNsPath()`: rejects `..`, `*`, `**`, empty segments, non-`[a-zA-Z0-9_-]` chars. Applied at every entry point. |
| **HIGH** | Password hash leakage — `passwordHash`+`passwordSalt` in `ns-meta/{path}` exposed to all clients via wildcard subscription (offline brute-force) | Moved hash/salt to separate `ns-meta/{path}/__auth` sub-path. Browse subscriptions (`ns-meta/*`) don't match it. `lookupNamespace()` returns only `hasPassword: true` flag. |
| **HIGH** | No creator check on metadata updates — any user could overwrite namespace metadata | Added `createdBy` check in `updateNamespaceMeta()` |
| **MEDIUM** | Async race in `createNamespace` — password hash via `.then()`, local state bootstrapped before hash written | Made `createNamespace()` properly `async`/`await`. ChatPage awaits it. |
| **MEDIUM** | Admin namespace move unguarded — any admin could move rooms to arbitrary namespaces | Added `isAdmin` check + target must be in `subscribedNamespaces` or `unlockedNamespaces` |

**Key Rotation Audit (confirmed working):**
On ban: `removePeerKey(rid, targetUserId)` prunes banned user's cached ECDH public key → `rotateRoomKey(rid)` generates fresh AES-256-GCM key → distributes only to remaining peers via ECDH. Old key cannot decrypt new messages. Banned user never receives new key. Forward secrecy works correctly.

**Remaining architectural notes:**
- All namespace auth is client-side enforced. Relay enforces CLASP write scopes on paths but doesn't understand namespace semantics. A malicious client crafting raw `set()` calls could bypass `createdBy` checks. True server-side enforcement would need relay-level namespace awareness.
- Room password verification is also client-side (pre-existing). Actual security comes from E2E encryption — without the key, messages are unreadable regardless.

## Current Deployment Architecture

```
relay.clasp.chat (157.230.84.254)
  ├── Caddy (ports 80/443) — TLS + reverse proxy
  │   ├── /auth/* → relay:7350 (auth HTTP)
  │   └── /* → relay:7330 (WebSocket)
  └── Relay (ghcr.io/lumencanvas/clasp-relay:latest)
      ├── WS: 7330
      ├── Auth: 7350
      ├── Rendezvous: 7340
      ├── --no-ttl --persist /data/state.json
      └── Data: /mnt/clasp_data/relay/

Auth scopes (20 total per user):
  read:/chat/user/{userId}/**           ← own data (profile, friends, DMs) [session 8]
  read:/chat/user/*/profile             ← other users' profiles (public) [session 8]
  read:/chat/room/**                    ← room data [session 8]
  read:/chat/registry/**                ← discovery [session 8]
  read:/chat/requests/{userId}          ← own friend request inbox [session 8]
  write:/chat/user/{userId}/**
  write:/chat/requests/*
  write:/chat/user/*/dms/*
  write:/chat/room/*/messages
  write:/chat/room/*/presence/{userId}
  write:/chat/room/*/typing/{userId}
  write:/chat/room/*/reactions/**
  write:/chat/room/*/video/**          ← session 5
  write:/chat/room/*/crypto/**
  write:/chat/room/*/admin/**
  write:/chat/room/*/bans/**
  write:/chat/room/*/meta
  write:/chat/registry/rooms/*
  write:/chat/registry/ns/**           ← session 6 (namespace room registry)
  write:/chat/registry/ns-meta/**      ← session 6 (namespace metadata + auth)
```

CI: push to `deploy/relay/**` or `crates/**` → GitHub Actions builds Docker image → pushes to GHCR → SSHes to Droplet → pulls and restarts.

Frontend: DigitalOcean App Platform auto-deploys from `apps/chat/` on push to `main`.

### Session 8: Security Hardening — Granular Scopes, DM Validation, Snapshot Filtering

Comprehensive server-side security hardening across the relay, router, and chat frontend.

**Scope restructuring (auth.rs):**
- Replaced global `read:/chat/**` with 5 granular read scopes:
  - `read:/chat/user/{userId}/**` — own data (profile, friends, DMs)
  - `read:/chat/user/*/profile` — other users' profiles (public)
  - `read:/chat/room/**` — room data
  - `read:/chat/registry/**` — discovery
  - `read:/chat/requests/{userId}` — own friend request inbox
- Total scopes per user: 15 → 20

**Router changes (clasp-router):**
- Added `has_strict_read_scope()` to `Session` — checks only explicit read scopes, prevents write-implies-read from granting subscription access
- Changed SUBSCRIBE handler to use `has_strict_read_scope()` instead of `has_scope(Action::Read, ...)`

**DM write validation (relay WriteValidator):**
- DM notifications (`/chat/user/*/dms/*`) now require `fromId` field
- `fromId` must match session identity (prevents spoofing)
- Server-side friendship check: verifies `/chat/user/{a}/friends/{b}` state exists before allowing DM writes
- Friend requests (`/chat/requests/*`) now require `fromId` matching session identity

**Snapshot filtering (relay SnapshotFilter):**
- Strips other users' private paths (DMs, friends, settings) from snapshots
- Anonymous sessions filtered from room internal paths (members, presence, typing)

**Client-side hardening:**
- Added `isFriend()` guard in `useRooms.js` `createDM()`

**Tests:** 98 relay tests pass (63 validator + 31 auth + 4 persistence), up from 14.

### Session 7: Mobile-First Overhaul, Crate Publish, CI Fix, README

Five areas of work across this session.

**Mobile-First Overhaul (5 phases, ~25 files):**

Comprehensive mobile-first redesign of the chat frontend. All mobile styles are the default; desktop overrides go inside media queries.

| Phase | Scope | Key Changes |
|-------|-------|-------------|
| **1. Foundation** | `index.html`, `style.css`, `AppLayout.vue` | `viewport-fit=cover`, iOS input zoom fix (`font-size: 16px` on inputs), safe area padding on body/toast, `100dvh`, tap highlight removal |
| **2. Touch Targets** | `MemberItem`, `FriendItem`, `RoomListItem`, `MessageItem`, `NamespaceCard`, `VideoControls`, `AdminPanel` | Min 44px touch targets everywhere, `:active` press feedback, hover-only actions made always-visible on mobile via `@media (hover: hover) and (pointer: fine)` |
| **3. Layouts** | `VideoControls`, `ComboChannelView`, `MessageComposer`, dialogs, `RoomDiscovery`, `ChatView`, `EmojiPicker` | `flex-wrap` on video controls, 40% mobile video split, `min-width: 0` on composer input (fix send button cutoff), `vh`→`dvh` on all modals, 1-column grids on mobile, scrollable breadcrumbs, full-width mobile emoji popover |
| **4. Typography** | All components | 0.75rem font floor enforced everywhere (was 0.6-0.7rem in many places), body text minimum 0.8rem |
| **5. Polish** | `VideoGrid`, `LocalPreview`, `KeyChangeWarning`, `SettingsPanel` | Image `max-width: 100%`, 2-column video grid on mobile, 48px join button, larger warning buttons |

**Mobile Bug Fixes (post-overhaul):**

| Bug | Root Cause | Fix |
|-----|-----------|-----|
| Send button cut off on mobile | `<input>` default intrinsic size prevents flex shrinking | Added `min-width: 0` to `.message-composer input` |
| Members panel not working on mobile | `.members-column` had `display: none` below 1024px with no mobile alternative | Added mobile overlay mode (fixed position slide-in from right with backdrop) in `AppLayout.vue` |
| Members overlay not dismissable | `AppLayout` emitted `toggle-members` on backdrop click but `ChatPage` didn't listen | Added `@toggle-members="showMembers = !showMembers"` on `<AppLayout>` in `ChatPage.vue` |
| No close button on members panel | Only way to close was backdrop tap or header button | Added members panel header with "Members" title and X close button in `AppLayout.vue` |

**Crate Version Bump & Publish (3.3.1 → 3.4.0):**

The relay's `validator.rs` imports `WriteValidator` and `SnapshotFilter` traits from `clasp-router`, but these only existed in the local crate — not the published v3.3.1 on crates.io. The Dockerfile stripped `[patch.crates-io]` so Docker builds failed.

Fix: Bumped workspace version to 3.4.0 and published all needed crates to crates.io in dependency order:

1. `clasp-core` 3.4.0 (no clasp deps)
2. `clasp-transport` 3.4.0 (depends on clasp-core)
3. `clasp-router` 3.4.0 (depends on clasp-core + clasp-transport) — now includes `WriteValidator` and `SnapshotFilter`
4. `clasp-discovery` 3.4.0 (depends on clasp-core + clasp-transport)

Updated `deploy/relay/Cargo.toml` deps: `clasp-core = "3.4"`, `clasp-router = "3.4"`, `clasp-discovery = "3.4"`. Dockerfile stays standalone (strips `[patch.crates-io]`, resolves from crates.io). Verified relay builds clean against published crates with no patches.

**CI Fixes (from earlier in session):**

| Issue | Fix |
|-------|-----|
| `cargo fmt` violations in clasp-router | Ran `cargo fmt --all` |
| error-classifier test: "timed out" not matched | Added `message.includes('timed out')` to match actual classifier logic |

**README:**

Added a "CLASP Chat" section to the main `README.md` covering:
- The core architectural insight (no dedicated chat server, just a generic relay)
- How chat concepts map to CLASP paths (`SET` vs `EMIT`)
- E2E encryption layer (ECDH key exchange, AES-256-GCM, ECDSA signing, key rotation)
- Video calling via CLASP signaling (WebRTC offer/answer/ICE as EMITs)
- Namespace hierarchy for room organization
- Why the architecture matters (relay never needs chat-specific updates)

## Known Issues / Next Steps

1. **Needs deploy**: Sessions 5-8 changes are pushed to main but not yet deployed to production. Crates need publishing at 3.5.0 so Docker build succeeds. Next push to `deploy/relay/**` or `crates/**` will trigger the deploy pipeline.
2. **Remaining crates unpublished at 3.5.0**: Only `clasp-core`, `clasp-transport`, `clasp-router`, `clasp-discovery` need publishing. Other crates (`clasp-client`, `clasp-bridge`, `clasp-cli`, `clasp-wasm`, `clasp-embedded`) are still at 3.3.1 on crates.io. Publish when needed or as a batch.
3. **`[patch.crates-io]` still in relay Cargo.toml**: Kept for local dev convenience. The Dockerfile strips it. If the patch section drifts from published versions, local builds will differ from Docker builds.
4. **Public channels timing**: Browse may not show rooms if SNAPSHOT is processed before subscriptions register. The params cache iteration fallback helps but may itself run before SNAPSHOT completes. A small delay or retry could improve reliability.
5. **Private rooms not server-enforced**: Anyone who knows a room UUID can access it. Server-side WriteValidator now enforces admin/meta/DM/friend-request rules, but room membership access control still requires server-side room membership tracking.
6. **Guest userId spoofing**: Guest endpoint accepts client-provided `user_id` — a malicious guest could claim another user's identity. Acceptable for current security model (guests are inherently anonymous), but real user verification would need server-side identity binding.
7. **Healthcheck noise**: Docker TCP healthcheck causes "Handshake not finished" errors in relay logs every 30s (harmless, cosmetic).
8. **Namespace auth is client-side only**: Creator checks for namespace metadata updates are enforced in the composable, not the relay. Server-side WriteValidator handles room admin/ban/meta rules, but namespace-specific enforcement still requires relay-level namespace awareness.
9. **`has_strict_read_scope` closes write-implies-read gap**: SUBSCRIBE now uses `has_strict_read_scope()` which only checks explicit read scopes — write scopes no longer grant subscription access. This prevents privilege escalation where a write scope could be used to eavesdrop on paths the user shouldn't read.

## Verification Commands

```bash
cd apps/chat && npx vitest run          # 112 tests pass
cd apps/chat && npx vite build          # zero errors
cargo check --workspace                 # workspace builds (v3.4.0)
cd deploy/relay && cargo test           # 14 tests pass
cd deploy/relay && cargo build --release # clean (uses [patch.crates-io] locally)

# Verify relay builds against published crates (simulates Docker build)
cd deploy/relay && cp Cargo.toml Cargo.toml.bak && \
  sed -i '' '/^\[patch\.crates-io\]/,$d' Cargo.toml && \
  cargo check && mv Cargo.toml.bak Cargo.toml

# Deployment
ssh root@157.230.84.254 "cd /opt/clasp/deploy/droplet && docker compose ps"
curl -X POST https://relay.clasp.chat/auth/guest \
  -H 'Content-Type: application/json' \
  -d '{"name":"test","user_id":"test-123"}'
```
