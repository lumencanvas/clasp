# Pentest Test Suite Rewrite â€” 2026-02-21

## What Was Built

55 pentest tests across 8 files testing security properties of the CLASP distributed infrastructure:

| File | Crate | Tests | Focus |
|---|---|---|---|
| `pentest_cap.rs` | clasp-caps | 10 | Token forgery, tampering, replay, scope escalation |
| `pentest_pat.rs` | clasp-caps | 5 | Glob matching, pattern subset bypass |
| `pentest_rul.rs` | clasp-rules | 7 | Loop prevention, exhaustion, cooldown, scope escape |
| `pentest_ent.rs` | clasp-registry | 7 | Entity signatures, status lifecycle, cross-store |
| `pentest_jnl.rs` | clasp-journal | 5 | Tampering, access control, snapshot corruption |
| `pentest_adm.rs` | relay | 6 | Auth bypass, privilege escalation, IDOR, injection |
| `pentest_fed.rs` | clasp-router | 10 | Namespace hijacking, loop, poisoning, accumulation |
| `pentest_wir.rs` | clasp-router | 5 | Malformed messages, type confusion, oversized, replay |

## Audit Findings

An audit found only 22 of 55 tests were meaningful. 33 were problematic:

- **6 tautological** - passed regardless of correctness (zero real assertions)
- **14 weak** - asserted "didn't crash" but not the actual security property
- **3 redundant** - duplicated another test exactly
- **1 bug documentation** - asserted the vulnerability EXISTS instead of preventing it
- **9 weak WIR/FED** - pure liveness checks ("response.is_some()")

## What Was Rewritten (33 Tests)

Every problematic test was rewritten with precise, falsifiable security assertions:

### Tautological -> Meaningful (6)
- **CAP-02**: Decode+tamper scopes, assert InvalidSignature; delegate wider, assert AttenuationViolation
- **CAP-05**: Extract TokenInfo, verify scopes; replay gives identical scopes; distinct nonces
- **RUL-05**: Assert output address/value exact match, assert `origin == "rule:{id}"`
- **JNL-01**: Write Float(42.0), tamper to 999.0, assert `results[0].value == Float(999.0)`
- **JNL-04**: Corrupt JSON syntax -> assert Err; corrupt schema -> assert Err
- **FED-10**: Subscribe before poison SET, verify subscription works, document delivery behavior

### Weak -> Meaningful (14)
- **CAP-04**: Tamper proof chain scopes -> InvalidSignature; strip root link -> UntrustedIssuer
- **FED-01**: Two peers, hijacker gets `/**`, assert both receive data (FINDING documented)
- **FED-04**: Count SETs received by sender in 500ms, assert <= 1 (no loop amplification)
- **FED-08**: Three phases: receive sensors, re-declare audio, verify sensors NOT received, audio IS
- **FED-09**: Assert error code == 300, message contains "uthenti", connection closed after
- **WIR-01**: No-handshake attacker gets no Welcome; handshake attacker survives garbage
- **WIR-02**: Second HELLO -> second Welcome; WELCOME from client -> no error; SET -> specific response
- **WIR-03**: Codec boundary: >65535 -> PayloadTooLarge; <65535 -> succeeds; router survives
- **WIR-04**: v99 -> Welcome or Error (specific match); raw JSON -> no valid response
- **WIR-05**: Post-flood: subscribe, SET, verify SET arrives via subscription (clean state)
- **PAT-02**: Exact pattern does NOT match wildcard address (directional)
- **PAT-03**: Empty address doesn't sneak through `/**`; subset relationships documented

### Redundant -> Replaced (3)
- **ENT-03**: Test ONLY reactivation path (suspension in ENT-02), assert correct entity ID
- **ENT-06**: Timestamp freshness: `with_max_token_age(1)`, sleep 2s, assert Expired
- **RUL-07**: Interval rules have `"interval:{id}"` origin (distinct from `"rule:{id}"`)

### Bug Documentation (1)
- **CAP-10**: End-to-end proof: delegate from `/*` to `/**`, validate, assert widened token grants multi-level access parent doesn't have

## Security Findings Discovered

1. **CAP-10 Scope Widening**: `pattern_is_subset("/lights/**", "/lights/*")` returns true. Allows delegation from single-level (`/*`) to recursive (`/**`). Severity: Medium. Fix: add `cp == "**"` check before `pp == "*"` handler.

2. **FED-01 Open-Mode Hijacking**: Any federation peer can declare `/**` and receive all traffic in open mode. Authenticated mode required for namespace isolation.

3. **JNL-01 No Integrity Verification**: Journal returns tampered SQLite data silently. No HMAC or checksum verification at the journal layer.

4. **FED-10 State Poisoning**: Federation peers can SET outside declared namespace in open mode. Namespace declarations are advisory only.

## How to Run

```bash
# Individual files
cargo test --test pentest_pat -p clasp-caps
cargo test --test pentest_cap -p clasp-caps
cargo test --test pentest_rul -p clasp-rules
cargo test --test pentest_ent -p clasp-registry
cargo test --test pentest_jnl -p clasp-journal --features sqlite
cd crates/clasp-router && cargo test --test pentest_wir
cd crates/clasp-router && cargo test --test pentest_fed --features federation
cd deploy/relay && cargo test --test pentest_adm --features registry

# Expected: 55 total test functions, all passing
```
